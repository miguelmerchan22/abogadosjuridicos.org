/*****
 * Google Apps Script para recibir datos de un formulario HTML y guardarlos en una hoja de cálculo.
 * Asegúrate de que la hoja activa tenga columnas con los encabezados correspondientes.
 * Orden esperado: Timestamp, Fuente, Nombre, Email, Telefono, AreaInteres, Mensaje
 *****/

// Hoja de cálculo donde se guardarán los datos.
const SHEET_NAME = 'abogadosjuridicos.org';
// Fuente fija para identificar los envíos de este formulario.
const SOURCE_ID = 'LandingMerchan';
// Obtiene la hoja de cálculo activa y la hoja específica por nombre.
const SPREADSHEET = SpreadsheetApp.getActiveSpreadsheet();
const SHEET = SPREADSHEET.getSheetByName(SHEET_NAME);

/**
 * Función que se ejecuta cuando se recibe una solicitud POST (desde el formulario HTML).
 * @param {Object} e - El objeto del evento que contiene los parámetros de la solicitud.
 * @returns {Object} - Un objeto JSON indicando el resultado (success o error).
 */
function doPost(e) {
  try {
    // Verifica si la hoja de destino existe.
    if (!SHEET) {
      throw new Error(`Hoja "${SHEET_NAME}" no encontrada. Verifica que el nombre de la hoja en tu Google Sheet sea exacto.`);
    }

    // Obtiene los datos del formulario del objeto del evento.
    const formData = e.parameter;

    // Crea una nueva fila con los datos.
    // ¡Orden de columnas actualizado! Mensaje es ahora la última.
    const newRow = [
      new Date(),         // Timestamp (Columna 1)
      SOURCE_ID,          // Fuente (Columna 2)
      formData.name || '',    // Nombre (Columna 3)
      formData.email || '',   // Email (Columna 4)
      formData.phone || '',   // Telefono (Columna 5 - Opcional)
      formData.area || '',     // Área de Interés (Columna 6) - Movido
      formData.message || ''  // Mensaje (Columna 7) - Movido al final
    ];

    // Añade la nueva fila a la hoja de cálculo.
    // LockService previene errores si llegan múltiples envíos casi al mismo tiempo.
    const lock = LockService.getScriptLock();
    lock.waitLock(30000); // Espera hasta 30 segundos para obtener el bloqueo

    try {
        SHEET.appendRow(newRow);
    } finally {
        lock.releaseLock(); // Libera el bloqueo
    }


    // Devuelve una respuesta JSON de éxito.
    return ContentService
      .createTextOutput(JSON.stringify({ result: 'success', message: 'Fila añadida correctamente.' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // Registra el error en los registros de Apps Script para depuración.
    Logger.log(`Error en doPost: ${error.message}\nStack: ${error.stack}`);
    Logger.log(`Datos recibidos (e.parameter): ${JSON.stringify(e.parameter)}`);


    // Devuelve una respuesta JSON de error detallada.
    return ContentService
      .createTextOutput(JSON.stringify({ result: 'error', message: `Error interno del servidor: ${error.message}` }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- Opcional: Función doGet para probar si el script está funcionando ---
/*
function doGet(e) {
  return HtmlService.createHtmlOutput("El script de Google Apps está activo y configurado para la hoja: " + SHEET_NAME);
}
*/